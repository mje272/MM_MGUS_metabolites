{% extends 'base.html' %}

{% block head %}
    <title>Home</title>
    <script>
        const metabolite_dict = {  //generate this from the online database
            "Lipid":{
                "Fatty Acid, Branched": ["(12 or 13)-methylmyristate (a15:0 or i15:0)", "(14 or 15)-methylpalmitate (a17:0 or i17:0)"],
                "Fatty Acid Metabolism (Acyl Carnitine, Hydroxy)": ["(R)-3-hydroxybutyrylcarnitine"]
            },
            "Xenobiotics":{
                "Chemical": ["1,2,3-benzenetriol sulfate (2)"],
                "Xanthine Metabolism": ["1,3,7-trimethylurate"]
            }
        };


        function clear_metabolite_select(unselect=true){ //hides everythin gin metabolite select and unselects if selected
            for (let sup_path_opt_group of document.getElementById("select_metabolite").children) {
                sup_path_opt_group.hidden = true;

                for (let sub_path_or_metab_opt of sup_path_opt_group.children) {
                    sub_path_or_metab_opt.hidden = true;
                }
            }
            if (unselect) {
                let metab_select = document.getElementById("select_metabolite");
                let selected_metab_ind = metab_select.selectedIndex;
                if (selected_metab_ind != -1) { //if metabolite selected, unselect it
                    metab_select.options[selected_metab_ind].selected = false; 
                }
            }
        }

        function narrow_selection_to_super_path(sup_path) { //make this unselect subpath
            clear_metabolite_select();
            let sup_path_cat_element = document.getElementById(sup_path + " category"); //set selected super path to be not hidden as well as its subpaths and metabolites
            sup_path_cat_element.hidden = false;
            for (let selected_sub_path_or_metab of sup_path_cat_element.children) {
                selected_sub_path_or_metab.hidden = false;
            }

            for (let sup_path in metabolite_dict) { // hide all in sub path selection; next loop unhides selected subpaths
                for (let sub_path in metabolite_dict[sup_path]) {
                    document.getElementById(sub_path).hidden = true;
                    document.getElementById(sub_path).selected = false;
                }
            }

            for (let sub_path in metabolite_dict[sup_path]) { //could also combine this with above loop with conditional
                document.getElementById(sub_path).hidden = false;
            }

            test(sup_path);
        }

        function reset_super_path() {
            for (let sup_path_opt_group of document.getElementById("select_metabolite").children) { //unhide everything in metabolite selection
                sup_path_opt_group.hidden = false;
                for (let sub_path_or_metab_opt of sup_path_opt_group.children) {
                    sub_path_or_metab_opt.hidden = false;
                }
            }
            for (let sup_path in metabolite_dict) { //show all in subpath select
                for (let sub_path in metabolite_dict[sup_path]) {
                    document.getElementById(sub_path).hidden = false;
                    document.getElementById(sub_path).selected = false; //also unselect subpaths
                }
            }
        }

        function narrow_selection_to_sub_path(super_path, sub_path) {
            narrow_selection_to_super_path(super_path); //in case you select sub before super
            document.getElementById(super_path).selected = true;
            document.getElementById(sub_path).selected = true;  //because selecting_super_path unselects subpaths

            super_path_cat_element = document.getElementById(super_path + " category");
            for (let sub_path_or_metab_opt of super_path_cat_element.children) { //hide all members of selected super path
                sub_path_or_metab_opt.hidden = true;
            }

            document.getElementById(sub_path + " category").hidden = false; //unhide selected sub path
            for (let selected_metab of metabolite_dict[super_path][sub_path]) {
                document.getElementById(selected_metab).hidden = false;
            }

        }

        function produce_options() {
            for (let super_path in metabolite_dict) {
                let super_path_node = document.createElement("optgroup");
                super_path_node.label = super_path;
                super_path_node.id = super_path + " category";

                for (let sub_path in metabolite_dict[super_path]) {  //make sure for in loop is ordered
                    let sub_path_node = document.createElement("option");
                    sub_path_node.innerHTML = sub_path;
                    sub_path_node.id = sub_path + " category";
                    sub_path_node.disabled = true; //make the subpath text bold or something
                    super_path_node.appendChild(sub_path_node);
                    
                    for (let metabolite_option of metabolite_dict[super_path][sub_path]) {
                        let metabolite_option_node = document.createElement("option");
                        metabolite_option_node.innerHTML = metabolite_option;
                        metabolite_option_node.id = metabolite_option;
                        metabolite_option_node.value = metabolite_option;  //can alternatively use numerical code or something
                        metabolite_option_node.onclick = function(){ narrow_selection_to_sub_path(super_path, sub_path); this.selected=true;}; //select sub path when selected; also select this option so doesnt get unselected by sup path select
                        super_path_node.appendChild(metabolite_option_node);
                    }

                    let sub_path_select_opt_node = document.createElement("option");
                    sub_path_select_opt_node.innerHTML = sub_path;
                    sub_path_select_opt_node.id = sub_path;
                    sub_path_select_opt_node.value = sub_path;
                    sub_path_select_opt_node.onclick = function(){ narrow_selection_to_sub_path(super_path, sub_path); };
                    document.getElementById("sub_path_select").appendChild(sub_path_select_opt_node);
                }

                document.getElementById("select_metabolite").appendChild(super_path_node);

                let super_path_select_opt_node = document.createElement("option");
                super_path_select_opt_node.innerHTML = super_path;
                super_path_select_opt_node.id = super_path;
                super_path_select_opt_node.value = super_path;
                super_path_select_opt_node.onclick = function(){ narrow_selection_to_super_path(super_path); };
                document.getElementById("super_path_select").appendChild(super_path_select_opt_node);

            }
        }

        function search_metabolite() { //can also make this more forgiving ie use regex, ignore capitalization, etc
            let search = document.getElementById("metab_search_bar").value; 
            test("10");
            clear_metabolite_select(unselect=false);

            let selected_super_path = document.getElementById("super_path_select").value; //search within selected fields
            if (selected_super_path) {
                let selected_sub_path = document.getElementById("sub_path_select").value;
                if (selected_sub_path) {
                    for (let metab in metabolite_dict[selected_super_path][selected_sub_path]) {
                        if (metab.includes(search)) {
                            document.getElementById(metab).hidden = false;
                        }
                    }
                } else {
                    for (let sub_path in metabolite_dict[selected_super_path]) {
                        for (let metab in metabolite_dict[selected_super_path][sub_path]) {
                            if (metab.includes(search)) {
                                document.getElementById(metab).hidden = false;
                                document.getElementById(sub_path + " category").hidden = false; //also show subpath (and superpath)
                            }
                        }
                    }
                }
            } else {
                for (let super_path in metabolite_dict) {
                    for (let sub_path in metabolite_dict[super_path]) {
                        for (let metab in metabolite_dict[super_path][sub_path]) {
                            if (metab.includes(search)) {
                                document.getElementById(metab).hidden = false;
                                document.getElementById(sub_path + " category").hidden = false;
                                document.getElementById(super_path + " category").hidden = false;
                            }
                        }
                    }
                }
            }

        }


        function test(test_code){
            document.getElementById("test_element").innerHTML = "TEST" + test_code;
        }

    </script>
{% endblock %}

{% block body_attributes %}
    onload="test('1'); produce_options();"
{% endblock %}

{% block body %}
    <h1>Select a metabolite</h1>

    <label for="super_path_select">Select a Super Pathway: </label>
    <br>
    <select id="super_path_select" size="5">
        <option selected onclick="reset_super_path();">All</option>
    </select>

    <br><br>

    <label for="sub_path_select">Select a Sub Pathway: </label>
    <br>
    <select id="sub_path_select" size="5">
    </select>

    <br><br>
    
    <form action="/query_metabolite" target="_blank" method="post" id="metabolite_search_form">
        <label for="select_metabolite">Select a Metabolite: </label>
        <br>
        <select id="select_metabolite" name="query_metabolite" form="metabolite_search_form" size="10" required>
            
        </select>
        <br>

        <!-- make this search bar narrow down selection options -->
        <label for="metab_search_bar">Search</label> 
        <input type="text" id="metab_search_bar" name="metab_search_bar" oninput="search_metabolite();">

        <!-- could make type=search -->
        <br><br>

        <button type="submit">Submit</button>
    </form>
    <br>
    
    <p id="test_element"></p>
    

{% endblock %}

